<html>
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Graduate&display=swap" rel="stylesheet">

    <link href="style.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <body onload=init()>
        <h1>The Story of Baseball</h1>
        <h2>Homeruns Throughout MLB History</h2>
        <div>
            <button type="button" class="btn btn-danger btn-lg" onclick="update('1920')">1920</button>
            <button type="button" class="btn btn-danger btn-lg" onclick="update('1950')">1950</button>
            <button type="button" class="btn btn-danger btn-lg" onclick="update('2000')">2000</button>
            <button type="button" class="btn btn-danger btn-lg" onclick="update('2019')">2019</button>
        </div>
        <svg width=1000 height=500 id="chart"></svg>        
        <script>
            width = 900;
            height = 400;
            margin = 50;
            tspanDy = 25;

            yearScale = d3.scaleTime().range([0, width - margin]);
            homerunScale = d3.scaleLinear().range([height, 0]);
            yearToData = {};

            async function init() {
                homeruns = await loadData();
                annotationsToDisplay = await loadAnnotations()

                yearToData = {
                    '1920': homerunsThrough(homeruns, 1920),
                    '1950': homerunsThrough(homeruns, 1950),
                    '2000': homerunsThrough(homeruns, 2000),
                    '2019': homeruns
                };

                yearScale.domain(d3.extent(yearToData['1920'], d => d.Year));
                homerunScale.domain(d3.extent(yearToData['1920'], d => d.Total));
                bisect = d3.bisector(function(d) { return d.Year;}).left;
                
                svg = d3.select("#chart");
                svg.append("g")
                    .attr("transform", "translate(" + margin +"," + margin +")")
                    .append('rect')
                    .attr("class", "back")
                    .attr('width', width - margin)
                    .attr('height', height)
                    .on('mouseover', mouseover)
                    .on('mousemove', mousemove)
                    .on('mouseout', mouseout);

                svg.append("clipPath")
                    .attr("id", "clippy")
                    .append("rect")
                    .attr("transform", "translate(" + margin + "," + margin + ")")
                        .attr("x", 0)
                        .attr("y", 0)
                        .attr("width", width - margin)
                        .attr("height", height)

                // draw line chart
                chart = svg.append("g")
                    .attr("transform", "translate(" + margin + "," + margin + ")")
                    .append("path")
                    .datum(homeruns)
                    .attr("class", "homerunChart")
                    .attr("clip-path", "url(#clippy)")
                    .attr("d", d3.line()
                      .x(d => yearScale(d.Year))
                      .y(d => homerunScale(d.Total))
                    )

                
                // tooltip that will be displayed when we hover over a specific area
                tooltip = d3.select("body")
                    .append("div")
                        .attr("class", "tip")
                        .style("visibility", "hidden");


                // ball that indicates location on graph
                ball = svg.append("g")
                    .attr("transform", "translate(" + margin +"," + margin +")")
                    .append("image")
                        .attr("class", "ball")
                        .attr("href", "https://static.vecteezy.com/system/resources/previews/001/203/107/large_2x/baseball-png.png")
                        .on('mouseover', mouseover)
                        .on('mousemove', mousemove)
                        .on('mouseout', mouseout);

                // annotationSVG = svg.append("svg")
                //     .attr("width", "50%")
                //     .attr("height", "25%")
                //     .attr("x", margin)
                //     .attr("y", margin)

                // annotationSVG.append("rect")
                //     .attr("class", "annotationSVG")
                //     .on('mouseover', mouseover)
                //     .on('mousemove', mousemove)
                //     .on('mouseout', mouseout);

                // annotationText = annotationSVG.append("text")
                //     .attr("x", 20)
                //     .attr("y", 20)

                // annotationText.selectAll("tspan")
                //     .data(annotationsToDisplay[0].facts)
                //     .enter()
                //     .append("tspan")
                //         .attr("x", 5)
                //         .attr("dy", tspanDy)
                //         .text((d) => d)

                // create y axis
                homerunAxis = d3.axisLeft(homerunScale)
                svg.append("g")
                    .attr("transform", "translate(" + margin +"," + margin +")")
                    .attr("class", "homerunScaleAxis")
                    .call(d3.axisLeft(homerunScale));

                // create x axis
                yearAxis = d3.axisBottom(yearScale)
                svg.append("g")
                    .attr("transform", "translate(" + margin +"," + (height + margin) +")")
                    .attr("class", "yearScaleAxis")
                    .call(d3.axisBottom(yearScale));

                function homerunsThrough (homeruns, year) {
                    return homeruns.filter(d => d.Year.getFullYear() <= year);
                }

                async function loadData() {
                    return await d3.csv("https://raw.githubusercontent.com/chrisfisch914/CS416-Project2/beautify/homeruns.csv",
                        function (d) {
                            return {
                                Year: d3.timeParse("%Y")(d.Year),
                                Total: parseInt(d.Total)
                            };
                        }
                    );
                }

                async function loadAnnotations() {
                    return await d3.json("https://raw.githubusercontent.com/chrisfisch914/CS416-Project2/master/annotations.json");
                }

                function mouseover() {
                    tooltip.style("visibility", "visible");
                    ball.style("opacity", 1);
                }

                function mousemove() {
                    x0 = yearScale.invert(d3.mouse(this)[0]);
                    index = bisect(homeruns, x0, 1);
                    selectedData = homeruns[index];

                    tooltip.html(formatToolTipText(selectedData));
                    tooltip.attr("transform", "translate(" + margin +"," + margin +")")
                    tooltip.style("top", homerunScale(selectedData.Total) + 25).style("left", yearScale(selectedData.Year) + 100)

                    ball.attr("x", yearScale(selectedData.Year) - 7);
                    ball.attr("y", homerunScale(selectedData.Total) - 7);
                }

                function mouseout() {
                    tooltip.style("visibility", "hidden");
                    ball.style("opacity", 0);
                }

                function formatToolTipText(data) {
                    return `
                        Year: ${data.Year.getFullYear()} </br>
                        Total HR's: ${data.Total}
                    `;
                }
            }

            function update(year, duration=3000) {
                data = yearToData[year];
                svg = d3.selectAll("svg");
                chart = svg.select(".homerunChart");

                // update x axis
                yearScale.domain(d3.extent(data, d => d.Year));
                svg.selectAll(".yearScaleAxis")
                    .transition()
                    .duration(duration)
                    .call(yearAxis);

                // update y axis
                homerunScale.domain(d3.extent(data, d => d.Total))
                svg.selectAll(".homerunScaleAxis")
                    .transition()
                    .duration(duration)
                    .call(homerunAxis);

                // update the chart
                chart.transition()
                    .duration(3000)
                    .attr("d", d3.line()
                      .x(d => yearScale(d.Year))
                      .y(d => homerunScale(d.Total))
                    );

                // update annotations
                anno = annotationsToDisplay.find(an => an.year == year)
                annotationText.selectAll("tspan").remove()
                annotationText.selectAll("tspan")
                    .data(anno.facts)
                    .enter()
                    .append("tspan")
                        .attr("x", 5)
                        .attr("dy", tspanDy)
                        .text((d) => d)
            }
        </script>
    </body>
</html>
